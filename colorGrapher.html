<!DOCTYPE html>
<html>
  <head>
    <title>RGB Grapher</title>
    <script type="text/javascript">//<![CDATA[
      "use strict";

      function initCanvas(cvs){
        cvs.canvas = cvs.querySelector("canvas");
        cvs.canvas.ctx = cvs.canvas.getContext("2d");
        cvs.canvas.clearAll = clearAll;
        cvs.minX = -5.0;
        cvs.maxX = 5.0;
        cvs.minY = -5.0;
        cvs.maxY = 5.0;
        cvs.minColor = 0.0;
        cvs.maxColor = 1.0;
        cvs.rFunction = cvs.querySelector(".rFunction");
        cvs.gFunction = cvs.querySelector(".gFunction");
        cvs.bFunction = cvs.querySelector(".bFunction");
        cvs.translateX = translateX;
        cvs.translateY = translateY;
        cvs.translateRow = translateRow;
        cvs.translateCol = translateCol;
        cvs.translateColor = translateColor;
        cvs.drawAxes = drawAxes;
        cvs.draw = drawGraph;

        var drawBtn = cvs.querySelector(".generate");
        drawBtn.addEventListener("click", drawGraph.bind(cvs));

        var downBtn = cvs.querySelector(".download");
        downBtn.addEventListener("click", downloadImage.bind(cvs));

        cvs.showAxes = cvs.querySelector(".showAxes");
        cvs.showAxes.addEventListener("change", drawGraph.bind(cvs));

        cvs.draw();
      }

      function clearAll(){
        this.ctx.clearRect(0, 0, this.width, this.height);
        if(this.imageBmp){
          this.ctx.save();
          this.ctx.globalAlpha = 0.5;
          this.ctx.drawImage(this.imageBmp, 0, 0);
          this.ctx.restore();
        }
      }

      function drawAxes() {
        if(this.showAxes.checked){
          var ctx = this.canvas.ctx;
          ctx.fillStyle = "white";
          if(this.minX <= 0.0 && this.maxX >= 0.0){
            var zeroCol = this.translateCol(0.0);
            ctx.fillRect(zeroCol, 0, 1, this.canvas.height);

            var notchSpacing = Math.pow(10, Math.ceil(Math.log10((this.maxY - this.minY)/5.0)) - 1);
            for(var y = this.minY; y <= this.maxY; y += notchSpacing){
              var row = this.translateRow(y);
              ctx.fillRect(zeroCol, row, 5, 1);
            }
          }
          if(this.minY <= 0.0 && this.maxY >= 0.0){
            var zeroRow = this.translateRow(0.0);
            ctx.fillRect(0, zeroRow, this.canvas.width, 1);

            var notchSpacing = Math.pow(10, Math.ceil(Math.log10((this.maxX - this.minX)/5.0)) - 1);
            for(var x = this.minX; x <= this.maxX; x += notchSpacing){
              var col = this.translateCol(x);
              ctx.fillRect(col, zeroRow, 1, -5);
            }
          }
        }
      }

      function drawGraph() {
        this.canvas.clearAll();
        var ctx = this.canvas.ctx;
        var imgData = ctx.createImageData(this.canvas.width, this.canvas.height);
        var rFn = new Function("x", "y", "return " + this.rFunction.value);
        var gFn = new Function("x", "y", "return " + this.gFunction.value);
        var bFn = new Function("x", "y", "return " + this.bFunction.value);
        for(var row = 0; row < this.canvas.height; row++){
          var y = this.translateY(row);
          for(var col = 0; col < this.canvas.width; col++){
            var x = this.translateX(col);

            var r = this.translateColor(rFn(x, y));
            var g = this.translateColor(gFn(x, y));
            var b = this.translateColor(bFn(x, y));

            applyColorToImage(imgData, this.canvas.width, col, row, r, g, b);
          }
        }
        ctx.putImageData(imgData, 0, 0);
        this.drawAxes();
      }

      function translateX(col){
        return ((col / this.canvas.width) * (this.maxX - this.minX)) + this.minX;
      }

      function translateY(row){
        return ((row / this.canvas.height) * (this.maxY - this.minY)) + this.minY;
      }

      function translateCol(x){
        return ((x - this.minX) / (this.maxX - this.minX)) * this.canvas.width;
      }

      function translateRow(y){
        return ((y - this.minY) / (this.maxY - this.minY)) * this.canvas.height;
      }

      function translateColor(c) {
        return ((c - this.minColor) / (this.maxColor - this.minColor)) * 255.0;
      }

      function downloadImage(evt){
        var data = this.canvas.toBlob(function(blob){
          var imgUrl = URL.createObjectURL(blob);
          var imgLink = document.querySelector("a.imgLink");
          imgLink.href = imgUrl;
          imgLink.download = "graph.png";
          imgLink.click();
        });
      }

      function applyColorToImage(imgData, width, x, y, r, g, b){
        var i = 4 * (y * width + x);
        imgData.data[i] = r;
        imgData.data[i+1] = g;
        imgData.data[i+2] = b;
        imgData.data[i+3] = 255;
      }

      window.addEventListener("load", function(){
        document.querySelectorAll(".grapher").forEach(initCanvas);
      })
    //]]></script>
  </head>
  <body>
    <div class="grapher">
      <canvas width="1000" height="1000" style="border: 1px solid black;"></canvas>
      <div class="controls">
        <label>
          r =
          <input type="text" class="rFunction" size="100" />
        </label>
        <br />
        <label>
          g =
          <input type="text" class="gFunction" size="100" />
        </label>
        <br />
        <label>
          b =
          <input type="text" class="bFunction" size="100" />
        </label>
        <br />
        <label>Show Axes <input type="checkbox" class="showAxes" checked /></label>
        <br />
        <button class="generate">Graph</button>
        <button class="download">Download Image</button>
        <a class="imgLink" style="display: none">image download</a>
      </div>
      <!--<img id="testImage" />-->
    </div>
  </body>
</html>
